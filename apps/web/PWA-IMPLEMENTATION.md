# PWA Implementation Guide

## Overview

The I Hate My Sink (IHMS) app is now a fully functional Progressive Web App (PWA) with offline support, installability, and automatic updates.

## Features Implemented

### 1. PWA Manifest

**Location**: Auto-generated by `vite-plugin-pwa` at build time

**Configuration**: `apps/web/vite.config.ts`

**Features**:
- App name: "I Hate My Sink"
- Short name: "IHMS"
- Description: "Field sales app for sink measurements and quotes"
- Display mode: Standalone (looks like a native app)
- Theme color: #2563eb (brand blue)
- Orientation: Portrait-primary (optimized for mobile)
- Icons: 192x192 and 512x512 SVG icons with maskable support

### 2. Service Worker

**Strategy**: Workbox-powered service worker with intelligent caching

**Caching Strategies**:

1. **tRPC API Calls** (NetworkFirst)
   - Tries network first, falls back to cache
   - 10-second network timeout
   - Caches up to 200 API responses
   - 24-hour cache expiration
   - Perfect for offline-first data access

2. **Images** (CacheFirst)
   - Serves from cache immediately
   - Updates cache in background
   - 100 image limit
   - 30-day expiration

3. **Fonts** (CacheFirst)
   - Aggressive caching for fonts
   - 30 font limit
   - 1-year expiration

4. **Static Assets (JS/CSS)** (StaleWhileRevalidate)
   - Serves cached version immediately
   - Updates cache in background
   - 100 asset limit
   - 7-day expiration

**Service Worker Features**:
- `cleanupOutdatedCaches`: Automatically removes old caches
- `skipWaiting`: Immediately activates new service worker
- `clientsClaim`: Takes control of all pages immediately

### 3. PWA Update Prompt

**Component**: `apps/web/src/components/PWAUpdatePrompt.tsx`

**Features**:
- Detects when a new version is available
- Shows a user-friendly update notification
- Allows users to update immediately or defer
- Automatically reloads the page after update
- Dismissible with "Later" option

**User Experience**:
- Non-intrusive bottom-right notification
- Clear "Reload" and "Later" buttons
- Accessible design with proper ARIA labels

### 4. PWA Install Prompt

**Component**: `apps/web/src/components/PWAInstallPrompt.tsx`

**Features**:
- Detects if app can be installed
- Shows install prompt for first-time users
- Respects user dismissal (stored in localStorage)
- Automatically hides on installed apps
- Supports iOS, Android, and desktop

**User Experience**:
- Bottom-left notification (opposite of update prompt)
- "Install" and "Not now" buttons
- Remembers user preference (won't show again if dismissed)

### 5. PWA Status Hook

**File**: `apps/web/src/hooks/usePWA.ts`

**Features**:
- `usePWA()`: React hook to check PWA installation status
- `isPWAInstalled()`: Utility to detect if running as installed PWA
- `isOnline()`: Utility to check network connectivity

**Returns**:
```typescript
{
  isInstalled: boolean;    // Is the app installed?
  isStandalone: boolean;   // Is running in standalone mode?
  canInstall: boolean;     // Can the app be installed?
  platform: 'ios' | 'android' | 'desktop' | 'unknown';
}
```

### 6. iOS Support

**Meta Tags** (in `apps/web/index.html`):
- `apple-mobile-web-app-capable`: Enables full-screen mode
- `apple-mobile-web-app-status-bar-style`: Native status bar appearance
- `apple-mobile-web-app-title`: Short name for home screen
- `apple-touch-icon`: Icon for iOS home screen

**Features**:
- Full-screen mode on iOS
- Native-like appearance
- Proper home screen icon
- Status bar integration

## Usage

### Development

The PWA features are enabled in development mode:

```bash
pnpm --filter @ihms/web dev
```

**Development Features**:
- Service worker runs in dev mode (via `devOptions.enabled: true`)
- PWA manifest is generated
- Install prompt works in development

### Production Build

```bash
pnpm --filter @ihms/web build
```

**Build Output**:
- Service worker: `dist/sw.js`
- PWA manifest: `dist/manifest.webmanifest`
- Workbox runtime: Injected into `sw.js`

### Testing PWA Features

1. **Install Prompt**:
   - Open app in Chrome/Edge
   - Wait for install prompt to appear
   - Click "Install" to add to home screen

2. **Update Prompt**:
   - Make a change to the app
   - Rebuild and redeploy
   - Open the app
   - Update prompt should appear within 1 hour (or on page reload)

3. **Offline Mode**:
   - Install the app
   - Open DevTools > Application > Service Workers
   - Check "Offline" checkbox
   - Navigate the app - cached pages should still work
   - API calls should return cached data

4. **iOS Testing**:
   - Open app in Safari on iOS
   - Tap Share button
   - Tap "Add to Home Screen"
   - Open the installed app
   - Should run in full-screen mode

## Service Worker Lifecycle

1. **Install**: Service worker downloads and caches static assets
2. **Activate**: Service worker takes control of the app
3. **Fetch**: Service worker intercepts network requests and applies caching strategies
4. **Update**: Checks for updates every hour (configurable)
5. **New Version**: Prompts user to reload when new version available

## Caching Strategy Details

### Network-First (tRPC API)

```
User Request → Try Network (10s timeout) → Cache → Error
                     ↓ Success
                 Return Response + Update Cache
```

**Best for**: Dynamic data that should be fresh but work offline

### Cache-First (Images, Fonts)

```
User Request → Cache Hit? → Return Cached
                     ↓ No
                 Network → Cache → Return
```

**Best for**: Static assets that rarely change

### Stale-While-Revalidate (JS, CSS)

```
User Request → Return Cached + Fetch New in Background
                     ↓
                 Update Cache
```

**Best for**: Assets that should be fast but eventually consistent

## Troubleshooting

### Service Worker Not Registering

1. Check browser console for errors
2. Ensure HTTPS or localhost (service workers require secure context)
3. Check Application > Service Workers in DevTools

### Updates Not Showing

1. Service worker checks for updates every hour
2. Force update: Unregister service worker in DevTools
3. Hard reload (Ctrl+Shift+R) to bypass cache

### Cache Issues

1. Clear cache in DevTools > Application > Storage
2. Unregister service worker
3. Hard reload

### Install Prompt Not Showing

1. Check if app is already installed
2. Check if user previously dismissed prompt
3. Clear localStorage: `localStorage.removeItem('pwa-install-dismissed')`
4. Ensure all PWA criteria are met (HTTPS, manifest, service worker, etc.)

## PWA Checklist

- [x] HTTPS (required for service workers)
- [x] Web App Manifest with required fields
- [x] Service Worker registered and active
- [x] Icons (192x192 and 512x512)
- [x] Offline fallback page
- [x] Install prompt
- [x] Update notifications
- [x] iOS meta tags
- [x] Theme color
- [x] Display mode: standalone

## Browser Support

- **Chrome/Edge**: Full PWA support including install prompt
- **Safari (iOS)**: Manual install via "Add to Home Screen"
- **Firefox**: Service workers supported, install prompt limited
- **Safari (macOS)**: Limited PWA support

## Future Enhancements

1. **Background Sync**: Queue API mutations when offline, sync when online
2. **Push Notifications**: Notify users of quote updates
3. **Periodic Background Sync**: Refresh data even when app is closed
4. **Share Target API**: Allow sharing to the IHMS app
5. **File Handling**: Open PDF files directly in the app
6. **iOS Splash Screens**: Custom splash screens for different device sizes

## Resources

- [MDN: Progressive Web Apps](https://developer.mozilla.org/en-US/docs/Web/Progressive_web_apps)
- [web.dev: PWA Checklist](https://web.dev/pwa-checklist/)
- [Workbox Documentation](https://developers.google.com/web/tools/workbox)
- [vite-plugin-pwa Documentation](https://vite-pwa-org.netlify.app/)
